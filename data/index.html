<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fan Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #f4f4f4;
        }

        .logo {
            width: 150px;
            margin-top: 20px;
        }

        h1,
        h2 {
            color: #216BFF;
        }

        #status {
            font-size: 1.2em;
        }

        .connected {
            color: green;
        }

        .disconnected {
            color: red;
        }

        .data {
            font-size: 1.5em;
            margin: 20px 0;
        }

        .button {
            background-color: #216BFF;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .button:active {
            background-color: #0a58ca;
        }

        #feedback {
            font-size: 1.2em;
            color: #555;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <img src="/Logo_app.svg" alt="Voltagenix Logo" class="logo">

    <h2>FAN CONTROL</h2>
    <div id="status">Status: <span id="connection-status" class="connected">connected</span></div>
    <div id="co2" class="data">CO2: -- ppm</div>
    <div id="rpm" class="data">RPM: -- /min</div>
    <div>
        <button class="button" onclick="sendCommand('MODE')">MODE</button>
        <div id="rotation-mode" class="data">Rotation: Left</div>
    </div>
    <div>
        <button class="button" onclick="sendCommand('SPEED_UP')">Speed +</button>
        <button class="button" onclick="sendCommand('SPEED_DOWN')">Speed -</button>
    </div>
    <div>
        <button class="button" onclick="sendCommand('AUTO')">AUTO</button>
        <button class="button" onclick="sendCommand('STOP')">STOP</button>
    </div>
    <div id="feedback">Awaiting command...</div>
    <script>
        const connectionStatus = document.getElementById("connection-status");
        const co2Element = document.getElementById("co2");
        const rpmElement = document.getElementById("rpm");
        const feedbackElement = document.getElementById("feedback");

        function updateRPM() {
            // Отправляем GET-запрос на сервер
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    // Обновляем содержимое элемента <div id="rpm">
                    document.getElementById('rpm').textContent = `RPM: ${data.value} /min`;
                })
                .catch(error => console.error('Error fetching RPM data:', error));
        }

        // Обновляем значение каждые 3 секунды
        setInterval(updateRPM, 1000);

        function updateData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    co2Element.textContent = `CO2: ${data.co2} ppm`;

                    // Если RPM отсутствует или равно 0, отображаем "RPM: 0 /min"
                    if (data.rpm === undefined || data.rpm === 0) {
                        rpmElement.textContent = "RPM: 0 /min";
                    } else {
                        rpmElement.textContent = `RPM: ${data.rpm} /min`;
                    }

                    rotationModeElement.textContent = `Rotation: ${data.rotation}`;
                })
                .catch(err => {
                    console.error("Failed to fetch data:", err);
                    connectionStatus.textContent = "disconnected";
                    connectionStatus.className = "disconnected";

                    // Сбрасываем текстовые значения в случае ошибки
                    co2Element.textContent = "CO2: -- ppm";
                    rpmElement.textContent = "RPM: -- /min";
                    rotationModeElement.textContent = "Rotation: --";
                });
        }


        function sendCommand(command) {
            feedbackElement.textContent = `Sending command: ${command}...`;
            fetch('/api/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `value=${command}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "ok") {
                        feedbackElement.textContent = `Command "${command}" OK`;
                    } else {
                        feedbackElement.textContent = `Error executing command: "${command}".`;
                    }
                    updateData(); // Update UI after command execution
                })
                .catch(err => {
                    feedbackElement.textContent = `Error communicating with the server.`;
                    console.error("Failed to send command:", err);
                });
        }

        // Initial status
        connectionStatus.textContent = "connected";
        connectionStatus.className = "connected";
        const rotationModeElement = document.getElementById("rotation-mode");
        // Update data every 3 seconds
        setInterval(updateData, 3000);
    </script>
</body>

</html>